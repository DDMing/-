# 参考业界架构 考虑程序的扩展

-----------------------
## 负载均衡
- 概念
  负载平衡（Load balancing）是一种计算机网络技术，用来在多个计算机（计算机集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，
以达到最佳化资源使用、最大化吞吐率、最小化响应时间、同时避免过载的目的。使用带有负载平衡的多个服务器组件，取代单一的组件，可以通过冗余提高可靠性。
负载平衡服务通常是由专用软体和硬件来完成。

- 负载均衡技术
  - DNS域名解析负载均衡 ![DNS域名解析负载均衡](http://images.cnitblog.com/i/381412/201407/181649235687549.jpg)
    优点:将负载均衡的工作转交给了DNS，省掉了网站管理维护负载均衡服务器的麻烦。
    缺点:
      1 目前的DNS是多级解析，每一级DNS都可能缓存A记录，当某台服务器下线后，即使修改了DNS的A记录，要使其生效仍然需要较长时间。这段期间，会导致用户访问已经下线的服务器造成访问失败。
      2 DNS负载均衡的控制权在域名服务商那里，网站无法对其做更多改善和管理。
  - 反向代理负载均衡 ![反向代理负载均衡](http://images.cnitblog.com/i/381412/201407/182145306624536.jpg)
    Web服务器不需要使用外部IP地址，而反向代理服务器则需要配置双网卡和内外部两套IP地址。
    优点：和反向代理服务器功能集成在一起，部署简单
    缺点：反向代理服务器是所有请求和响应的中转站，其性能可能会成为瓶颈。
  - IP负载均衡![IP负载均衡](http://images.cnitblog.com/i/381412/201407/182157070532417.jpg)
    优点:在内核进程完成数据分发，较反向代理负载均衡（在应用程序中分发数据）有更好的处理性能。
    缺点:由于所有请求响应都需要经过负载均衡服务器，集群的最大响应数据吞吐量不得不受制于负载均衡服务器网卡带宽。
  - 数据链路层负载均衡 ![数据链路层负载均衡](http://images.cnitblog.com/i/381412/201407/182303190069562.jpg)
    此种方式又称作三角传输模式，负载均衡数据分发过程中不修改IP地址，只修改mac地址，由于实际处理请求的真实物理IP地址和数据请求目的IP地址一致，所以不需要通过负载均衡服务器进行地址转换，可将响应数据包直接返回给用户浏览器，避免负载均衡服务器网卡带宽成为瓶颈。这种负载均衡方式又称作直接路由方式（DR）

  > 在Linux平台上最好的链路层负载均衡开源产品是LVS(Linux Virutal Server).
    
- **负载均衡算法**
  - 轮询
  - 加权轮询
  - 随机
  - 最少链接
  - 源地址散列
  
### [**Linux Virtual Server**](http://www.linuxvirtualserver.org/zh/lvs3.html)
- IP负载均衡技术
  - **VS/NAT** 主要有通过网络地址转换（Network Address Translation）将一组服务器构成一个高性能的、高可用的虚拟服务器
    - **优点** 服务器可以运行任何支持TCP/IP的操作系统，它只需要一个IP地址配置在调度器上，服务器组可以用私有的IP地址
    - **缺点** 伸缩能力有限， 当服务器结点数目升到20时，调度器本身有可能成为系统的新瓶颈，因为在VS/NAT中请求和响应报文都需要通过负载调度器
  - **VS/TUN** 在分析VS/NAT的缺点和网络服务的非对称性的基础上，我们提出了通过IP隧道实现虚拟服务器的方法
    在VS/TUN 的集群系统中，负载调度器只将请求调度到不同的后端服务器，后端服务器将应答的数据直接返回给用户。这样，负载调度器就可以处理大量的请求，它甚至可以调 度百台以上的服务器（同等规模的服务器），而它不会成为系统的瓶颈。即使负载调度器只有100Mbps的全双工网卡，整个系统的最大吞吐量可超过 1Gbps。所以，VS/TUN可以极大地增加负载调度器调度的服务器数量。VS/TUN调度器可以调度上百台服务器，而它本身不会成为系统的瓶颈，可以 用来构建高性能的超级服务器。
  - **VS/TUN** 通过直接路由实现虚拟服务器的方法
    - 跟VS/TUN方法一样，VS/DR调度器只处理客户到服务器端的连接，响应数据可以直接从独立的网络路由返回给客户。这可以极大地提高LVS集群系统的伸缩性。
    - 跟VS/TUN相比，这种方法没有IP隧道的开销，但是要求负载调度器与实际服务器都有一块网卡连在同一物理网段上，服务器网络设备（或者设备别名）不作ARP响应，或者能将报文重定向（Redirect）到本地的Socket端口上。

- [**负载调度**](http://www.linuxvirtualserver.org/zh/lvs4.html)
  - 内核中的连接调度算法
    - 轮叫调度（Round-Robin Scheduling）
    - 加权轮叫调度（Weighted Round-Robin Scheduling）
    - 最小连接调度（Least-Connection Scheduling）
    - 加权最小连接调度（Weighted Least-Connection Scheduling）
    - 基于局部性的最少链接（Locality-Based Least Connections Scheduling）
    - 带复制的基于局部性最少链接（Locality-Based Least Connections with Replication Scheduling）
    - 目标地址散列调度（Destination Hashing Scheduling）
    - 源地址散列调度（Source Hashing Scheduling）
    
  - 动态反馈负载均衡算法
    动态反馈负载均衡算法考虑服务器的实时负载和响应情况，不断调整服务器间处理请求的比例，来避免有些服务器超载时依然收到大量请求，从而提 高整个系统的吞吐率。

  > 因为请求的服务时间差异较大，内核中的连接调度算法容易使得服务器运行出现倾斜。为此，给出动态反馈负载均衡算法，结合内核中的加权连接调度算法，根据动态反馈回来的负载信息来调整服务器的权值，来调整服务器间处理请求数的比例，从而避免服务器间的负载不平衡。动态反馈负载算法可以较好地避免 服务器的倾斜，提高系统的资源使用效率，从而提高系统的吞吐率。
     
  
----------------------------
参考来源：
  - [阿里云负载均衡](https://www.aliyun.com/product/slb/)
  - [LVS文档](http://www.linuxvirtualserver.org/zh/lvs3.html)
  - [路人博客1](http://www.cnblogs.com/edisonchou/p/3851333.html)
